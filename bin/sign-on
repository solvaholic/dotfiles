#!/bin/sh

#
# Use this script to do some housekeeping when you sign on.
#
# Usage:
#   [DEBUG=1] sign-on

# shellcheck disable=SC1117
# shellcheck disable=SC2039


# Load ~/.dotfiles.conf and $DOTFILES_ROOT/dotfiles.sh.
# shellcheck disable=SC1090
. ~/.dotfiles.conf || exit
. "$DOTFILES_ROOT/dotfiles.sh" || exit
debug "$0: Loaded ~/.dotfiles.conf and ran $DOTFILES_ROOT/dotfiles.sh OK."


_self="${0##*/}"

main () {
  check_preq || return 1
  # run_updates || _result=$_result+1
  # prune_docker || _result=$_result+1
  # pull_docker || _result=$_result+1
  _mux -s dotfiles -w docker "$DOTFILES_ROOT/bin/docker-clean"
  # pull_repos || _result=$_result+1
  link_dirs || _result=$_result+1
  return $((_result))
}


check_preq () {
  info "$_self: Check for prerequisites."
  _result=0
  # COMMANDS
  for _cmd in id docker _mux; do
    if command -v "$_cmd"; then
      debug "$_self: check_preq() found command '$_cmd' OK."
    else
      fail "$_self: check_preq() did not find command '$_cmd'."
      _result=$_result+1
    fi
  done
  # PATH ELEMENTS
  # shellcheck disable=SC2066
  for _path in "$HOME/Local/bin"; do
    if [[ ":$PATH:" = *":$_path:"* ]] ; then
      debug "$_self: check_preq() found '$_path' in \$PATH OK."
    else
      fail "$_self: check_preq() did not find '$_path' in \$PATH."
      _result=$_result+1
    fi
  done
  return $((_result))
}


link_dir () {
  # TODO: Can link_file() from $DOTFILES_ROOT/dotfiles.sh handle
  # this?
  _lnksrc="$1"     # What the link links to
  _lnktgt="$2"     # The link to create
  _result=0
  debug "$_self: START 'link_dir( $_lnksrc, $_lnktgt )'."
  if [ -L "$_lnktgt" ]; then
    debug "$_self: Link '$_lnktgt' already exists."
  elif [ -e "$_lnktgt" ]; then
    info "$_self: '$_lnktgt' already exists."
  elif ln -s "$_lnksrc" "$_lnktgt"; then
    success "$_self: Created link '$_lnktgt', to '$_lnksrc'."
  else
    fail "$_self: 'link_dir( $_lnksrc, $_lnktgt )' failed."
    _result=1
  fi
  if [ ! -r "$_lnktgt" ]; then
    info "$_self: '$_lnktgt' is not readable."
  fi
  debug "$_self: FINISH 'link_dir( $_lnksrc, $_lnktgt )'."
  return $((_result))
}

link_dirs () {
  info "$_self: Linking directories."
  _result=0
  mkdir -p ~/Local
  link_dir "../.dotfiles/bin" ~/"Local/bin" || _result=$_result+1
  link_dir "Library/Mobile Documents/com~apple~CloudDocs" ~/"iCloud" || _result=$_result+1
  return $((_result))
}

if ! main; then
  echo "That did not work."
  exit 1
fi
